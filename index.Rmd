---
output: html_document
toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Spatial Interpolation: meuse

## Data

```{r, warning=FALSE, message=FALSE}
library(sp)
library(gstat)
library(sf)
library(mapview)
library(tidyverse)
```

```{r}
data(meuse)
head(meuse)
ggplot(data = meuse) + geom_point(aes(x, y))
```

```{r}
data(meuse.grid)
head(meuse.grid)
ggplot(data = meuse.grid) + geom_point(aes(x, y))
```





## Summary Statistics

```{r}
summary(meuse)
```

### Bubble plot

```{r}
ggplot(data = meuse) + geom_point(aes(x, y, size=zinc))
```

## Spatial Data Wrangling

```{r}
class(meuse)
class(meuse.grid)
```

### Convert the meuse and meuse.grid data frames to sf objects using the st_as_sf()

```{r}
meuse2 <- st_as_sf(meuse, coords = c("x", "y"), crs = 28992)
meuse.grid2 <- st_as_sf(meuse.grid, coords = c("x", "y"),
                       crs = 28992)
```

### Recheck class type

```{r}
class(meuse2)
class(meuse.grid2)
```

```{r}
head(meuse2)
head(meuse.grid2)
```

### Interactive maps 

```{r}
mapview(meuse2, zcol = "zinc",  map.types = "CartoDB.Voyager")
mapview(meuse.grid2,  map.types = "CartoDB.Voyager")
```

## EDA

```{r}
ggplot(meuse, aes(x=dist, y=zinc)) + geom_point()
```

```{r}
ggplot(meuse, aes(x=dist, y=log(zinc))) + geom_point()
```

```{r}
ggplot(meuse, aes(x=sqrt(dist), y=log(zinc))) + geom_point()
```

### Simple Linear Regression Model

```{r}
lm <- lm(log(zinc)~sqrt(dist), meuse)
meuse$residuals <- residuals(lm)
meuse$fitted <- fitted(lm) 
meuse$fitted2 <- predict(lm, meuse) 
meuse$fitted.s <- predict(lm, meuse) - mean(predict(lm, meuse))
head(meuse)
```

```{r}
library(viridis)
ggplot(meuse, aes(x=x, y=y, col=fitted))+geom_point()+scale_color_viridis()
ggplot(meuse, aes(x=x, y=y, col=residuals))+geom_point()+scale_color_viridis()
ggplot(meuse, aes(x=x, y=y, col=fitted.s))+geom_point()+scale_color_viridis()
```

## Inverse Distance Interpolation

```{r}
library(stars) |> suppressPackageStartupMessages()
library(gstat)
idw_result <- idw(zinc~1, meuse2, meuse.grid2)
idw_result
# Convert IDW output to a data frame
idw_df <- as.data.frame(idw_result)
head(idw_df)
colnames(idw_df) <- c("x", "y", "zinc_pred")
head(idw_df)

```

### Visualize IDW values

```{r}
ggplot(data = meuse2) + geom_sf(data = idw_result, aes(color = var1.pred)) +
  geom_sf() +
  scale_color_viridis() + theme_bw()
```

## Spatial Kriging

### Lagged Scatter plots

```{r}
hscat(log(zinc)~1, meuse2, (0:9)*100)
```

### Variogram Cloud

```{r}
vc <- variogram(log(zinc) ~ 1, meuse2, cloud = TRUE)
plot(vc)
```

### Binned Variogram/ Sample Variogram

```{r}
v <- variogram(log(zinc) ~ 1, data = meuse2)
plot(v)
```

### List of available models for variograms

```{r}
vgm()
show.vgms(par.strip.text = list(cex = 0.75))
```

### Fitting Variogram Models

### Trial 1

#### Assess our initial model

```{r}
vg.fit1 <- vgm(psill = 0.5, model = "Sph",
                range = 900, nugget = 0.1)
vg.fit1 
plot(v, vg.fit1 , cutoff = 1000, cex = 1.5)
```

### Fit a variogram providing the sample variogram

```{r}
fv <- fit.variogram(object = v,
                    model = vgm(psill = 0.5, model = "Sph",
                                range = 900, nugget = 0.1))
fv
attr(fv, "SSErr")
plot(v, fv, cex = 1.5)
```

### Trial 2


```{r}
fv2 <- fit.variogram(object = v,
                    model = vgm(psill = 0.6, model = "Sph",range = 900, nugget = 0.1))
fv2
attr(fv2, "SSErr")
plot(v, fv2, cex = 1.5)
```

### Trial 3


```{r}
fv3 <- fit.variogram(object = v,
                    model = vgm(psill = 1, model = "Exp",range = 800, nugget = 0.1))
fv3
attr(fv3, "SSErr")
plot(v, fv3, cex = 1.5)
```

#### If the process is isotropic we can directly go for kriging

```{r}
library(ggplot2)
library(viridis)

k <- gstat(formula = log(zinc) ~ 1, data = meuse2, model = fv)
kpred <- predict(k, meuse.grid2)
head(kpred)
```

#### Visualisation of Predictions

```{r}
ggplot() + geom_sf(data = kpred, aes(color = var1.pred)) +
  geom_sf(data = meuse2) +
  scale_color_viridis(name = "log(zinc)") + theme_bw()

ggplot() + geom_sf(data = kpred, aes(color = var1.var)) +
  geom_sf(data = meuse2) +
  scale_color_viridis(name = "variance") + theme_bw()
```